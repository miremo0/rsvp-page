<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest List - Our Autumn Wedding</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, get, onValue, update } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-Owb-RYgi0khn4GW0qBxcZD2zc6cP6Gk",
            authDomain: "mywed-5a5b9.firebaseapp.com",
            databaseURL: "https://mywed-5a5b9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywed-5a5b9",
            storageBucket: "mywed-5a5b9.firebasestorage.app",
            messagingSenderId: "537064292333",
            appId: "1:537064292333:web:c18ee6c8cbc08cf2b931e4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Function to hash password using Web Crypto API
        async function hashPassword(password) {
            const msgUint8 = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Function to verify admin password
        async function verifyAdminPassword(password) {
            try {
                const adminRef = ref(database, 'admin/password');
                const snapshot = await get(adminRef);
                
                if (snapshot.exists()) {
                    // Get the hashed password from Firebase
                    const hashedPasswordFromDB = snapshot.val();
                    
                    // Hash the input password
                    const hashedInput = await hashPassword(password);
                    console.log('Input Hash:', hashedInput);
                    console.log('DB Hash:', hashedPasswordFromDB);
                    
                    // Compare the hashes
                    return hashedInput === hashedPasswordFromDB;
                }
                return false;
            } catch (error) {
                console.error('Error verifying password:', error);
                return false;
            }
        }

        // Function to update guest sides
        async function updateGuestSides() {
            try {
                const guestsRef = ref(database, 'guests');
                const snapshot = await get(guestsRef);
                
                if (snapshot.exists()) {
                    const guests = snapshot.val();
                    const updates = {};
                    
                    Object.entries(guests).forEach(([key, guest]) => {
                        console.log(`Processing guest: ${guest.name}, Category: ${guest.category}, Role: ${guest.role}`);
                        
                        let side;
                        const role = guest.role ? guest.role.toLowerCase() : '';
                        
                        // First check if the role contains explicit side indicators
                        if (role.includes('brides')) {
                            side = 'bride';
                        } else if (role.includes('grooms')) {
                            side = 'groom';
                        } else if (role.startsWith('bride')) {
                            side = 'bride';
                        } else if (role.startsWith('groom')) {
                            side = 'groom';
                        }
                        
                        // If no side was determined by prefix, check category-specific rules
                        if (!side) {
                            if (guest.category === 'Principal') {
                                if (role.includes('ninong')) {
                                    side = 'groom';
                                } else if (role.includes('ninang')) {
                                    side = 'bride';
                                }
                            } else if (guest.category === 'Entourage') {
                                if (role.includes('groomsmen') || 
                                    role.includes('bestman') || 
                                    role.includes('best man')) {
                                    side = 'groom';
                                } else if (role.includes('bridesmaid') || 
                                         role.includes('maid of honor') || 
                                         role.includes('matron of honor')) {
                                    side = 'bride';
                                }
                            }
                        }

                        // If we determined a side, update it
                        if (side) {
                            console.log(`Setting ${guest.name} to ${side} side`);
                            updates[`guests/${key}/side`] = side;
                        }

                        // Check if the category needs to be updated (e.g., Mary Grace Ong)
                        if (guest.name === 'Mary Grace Ong' && guest.category !== 'Family') {
                            updates[`guests/${key}/category`] = 'Family';
                            console.log(`Updating ${guest.name}'s category to Family`);
                        }
                    });
                    
                    // Apply updates if there are any
                    if (Object.keys(updates).length > 0) {
                        console.log('Updates to be applied:', updates);
                        await update(ref(database), updates);
                        console.log('Guest sides and categories updated successfully');
                        return true;
                    } else {
                        console.log('No updates needed');
                    }
                    return false;
                }
                return false;
            } catch (error) {
                console.error('Error updating guest sides:', error);
                return false;
            }
        }

        // Function to load and display guest list
        async function loadGuestList() {
            try {
                // Update guest sides before loading the list
                await updateGuestSides();
                
                const guestsRef = ref(database, 'guests');
                onValue(guestsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const guests = snapshot.val();
                        displayGuestList(guests);
                    } else {
                        console.log('No guests found');
                        displayNoGuests();
                    }
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });
            } catch (error) {
                console.error('Error loading guest list:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Function to display guest list
        function displayGuestList(guests) {
            const guestCategories = document.getElementById('guestCategories');
            guestCategories.innerHTML = '';

            // Group guests by category and side
            const categories = {};
            Object.values(guests).forEach(guest => {
                const category = guest.category || 'Other';
                if (!categories[category]) {
                    categories[category] = {
                        bride: [],
                        groom: []
                    };
                }
                const side = guest.side || 'bride';
                categories[category][side].push(guest);
            });

            // Sort function for roles
            function getRolePriority(role) {
                const roleLower = (role || '').toLowerCase();
                // Entourage priorities
                if (roleLower.includes('maid of honor')) return 1;
                if (roleLower.includes('best man') || roleLower.includes('bestman')) return 1;
                if (roleLower.includes('bridesmaid')) return 2;
                if (roleLower.includes('groomsmen')) return 2;
                // Family priorities
                if (roleLower.includes('mother')) return 1;
                if (roleLower.includes('father')) return 1;
                if (roleLower.includes('brother')) return 2;
                if (roleLower.includes('sister')) return 2;
                if (roleLower.includes('cousin')) return 3;
                // Guest priorities
                if (roleLower.includes('friend')) return 1;
                if (roleLower.includes('guest')) return 2;
                return 99; // Default priority
            }

            // Sort guests within each category and side
            Object.keys(categories).forEach(category => {
                ['bride', 'groom'].forEach(side => {
                    categories[category][side].sort((a, b) => {
                        const priorityA = getRolePriority(a.role);
                        const priorityB = getRolePriority(b.role);
                        if (priorityA !== priorityB) {
                            return priorityA - priorityB;
                        }
                        // If same priority, sort alphabetically by name
                        return a.name.localeCompare(b.name);
                    });
                });
            });

            // Sort categories
            const sortedCategories = Object.keys(categories).sort((a, b) => {
                const order = ['Family', 'Principal', 'Entourage', 'Secondary Sponsors', 'Guest', 'Friends', 'Other'];
                return order.indexOf(a) - order.indexOf(b);
            });

            // Create category sections
            sortedCategories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'guest-category';

                // Determine column titles based on category
                let leftColumnTitle, rightColumnTitle;
                switch(category) {
                    case 'Principal':
                        leftColumnTitle = 'Ninang';
                        rightColumnTitle = 'Ninong';
                        break;
                    case 'Entourage':
                        leftColumnTitle = 'Bridesmaid';
                        rightColumnTitle = 'Groomsmen';
                        break;
                    default:
                        leftColumnTitle = "Bride's Side";
                        rightColumnTitle = "Groom's Side";
                }

                categorySection.innerHTML = `
                    <h2 class="category-title">${category}</h2>
                    <div class="two-column-grid">
                        <div class="column">
                            <h3 class="side-title">${leftColumnTitle}</h3>
                            <div class="guest-grid">
                                ${categories[category].bride.map(guest => `
                                    <div class="guest-card">
                                        <div class="guest-info">
                                            <div class="guest-name">${guest.name}</div>
                                            <div class="guest-role">${guest.role || ''}</div>
                                        </div>
                                        <div class="guest-card-actions">
                                            <div class="guest-status ${guest.rsvpStatus === 'Attending' ? 'status-attending' : 'status-pending'}">
                                                ${guest.rsvpStatus || 'Pending'}
                                            </div>
                                            <button class="generate-link-btn" onclick="window.generateInvitationLink('${guest.name.replace(/'/g, "\\'")}', '${(guest.accessCode || '').replace(/'/g, "\\'")}').catch(error => console.error('Error:', error))">
                                                Get Link
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="column">
                            <h3 class="side-title">${rightColumnTitle}</h3>
                            <div class="guest-grid">
                                ${categories[category].groom.map(guest => `
                                    <div class="guest-card">
                                        <div class="guest-info">
                                            <div class="guest-name">${guest.name}</div>
                                            <div class="guest-role">${guest.role || ''}</div>
                                        </div>
                                        <div class="guest-card-actions">
                                            <div class="guest-status ${guest.rsvpStatus === 'Attending' ? 'status-attending' : 'status-pending'}">
                                                ${guest.rsvpStatus || 'Pending'}
                                            </div>
                                            <button class="generate-link-btn" onclick="window.generateInvitationLink('${guest.name.replace(/'/g, "\\'")}', '${(guest.accessCode || '').replace(/'/g, "\\'")}').catch(error => console.error('Error:', error))">
                                                Get Link
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                guestCategories.appendChild(categorySection);
            });
        }

        function displayNoGuests() {
            const guestCategories = document.getElementById('guestCategories');
            guestCategories.innerHTML = '<div class="no-guests">No guests found</div>';
        }

        // Function to generate a random access code
        function generateAccessCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }

        // Function to update guest's access code
        async function updateGuestAccessCode(guestName, newAccessCode) {
            try {
                const guestsRef = ref(database, 'guests');
                const snapshot = await get(guestsRef);
                
                if (snapshot.exists()) {
                    const guests = snapshot.val();
                    const guestKey = Object.keys(guests).find(key => 
                        guests[key].name === guestName
                    );

                    if (guestKey) {
                        const updates = {};
                        updates[`guests/${guestKey}/accessCode`] = newAccessCode;
                        await update(ref(database), updates);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error updating access code:', error);
                return false;
            }
        }

        // Function to generate invitation link
        async function generateInvitationLink(guestName, accessCode) {
            let finalAccessCode = accessCode;
            
            if (!finalAccessCode) {
                finalAccessCode = generateAccessCode();
                const updated = await updateGuestAccessCode(guestName, finalAccessCode);
                if (!updated) {
                    alert('Error: Could not generate access code. Please try again.');
                    return;
                }
            }

            const baseUrl = window.location.origin + window.location.pathname.replace('guests.html', 'rsvp.html');
            const link = `${baseUrl}?guest=${encodeURIComponent(guestName)}&code=${encodeURIComponent(finalAccessCode)}`;
            
            document.getElementById('guestNameSpan').textContent = guestName;
            document.getElementById('invitationLink').value = link;
            document.getElementById('accessCode').textContent = finalAccessCode;
            document.getElementById('linkModal').classList.remove('hidden');
        }

        // Function to copy link
        function copyLink() {
            const linkInput = document.getElementById('invitationLink');
            linkInput.select();
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copyLink');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy';
            }, 2000);
        }

        // Function to close modal
        function closeModal() {
            document.getElementById('linkModal').classList.add('hidden');
        }

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing authentication
            if (sessionStorage.getItem('isAuthenticated')) {
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadGuestList();
            }

            // Password check
            document.getElementById('submitPassword').addEventListener('click', async function() {
                const password = document.getElementById('guestListPassword').value;
                const loadingIndicator = document.getElementById('loadingIndicator');
                const passwordError = document.getElementById('passwordError');
                
                try {
                    loadingIndicator.classList.remove('hidden');
                    passwordError.textContent = '';
                    
                    const isValid = await verifyAdminPassword(password);
                    
                    if (isValid) {
                        sessionStorage.setItem('isAuthenticated', 'true');
                        document.getElementById('passwordOverlay').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        loadGuestList();
                    } else {
                        passwordError.textContent = 'Incorrect password';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    passwordError.textContent = 'Error verifying password. Please try again.';
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            });

            // Handle enter key
            document.getElementById('guestListPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('submitPassword').click();
                }
            });

            // Handle modal close when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('linkModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
        });

        // Make functions available globally
        window.loadGuestList = loadGuestList;
        window.generateInvitationLink = generateInvitationLink;
        window.copyLink = copyLink;
        window.closeModal = closeModal;
        window.updateGuestSides = updateGuestSides;
    </script>
</head>
<body>
    <div class="falling-leaves"></div>
    <div class="container">
        <div id="passwordOverlay" class="password-overlay">
            <div class="password-container">
                <h2>Private Guest List</h2>
                <p>Please enter the password to view the guest list</p>
                <div class="password-form">
                    <input type="password" id="guestListPassword" placeholder="Enter password">
                    <button id="submitPassword" class="rsvp-button">View Guest List</button>
                </div>
                <div id="passwordError" class="password-error"></div>
            </div>
        </div>

        <div id="mainContent" class="hidden">
            <header class="header">
                <a href="index.html" class="back-home">‚Üê Back to Home</a>
                <h1 class="page-title">Guest List</h1>
            </header>

            <main class="guest-list-container">
                <div class="guest-list-header">
                    <div id="loadingIndicator" class="loading-indicator">
                        Loading guest list...
                    </div>
                    <div class="status-legend">
                        <span class="status-dot attending"></span> Attending
                        <span class="status-dot pending"></span> Pending
                    </div>
                </div>

                <div class="guest-categories" id="guestCategories">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div id="linkModal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-modal" onclick="closeModal()">&times;</span>
                        <h2>Invitation Link</h2>
                        <div class="invitation-details">
                            <p>Share this link with <span id="guestNameSpan"></span>:</p>
                            <div class="link-container">
                                <input type="text" id="invitationLink" readonly>
                                <button id="copyLink" class="copy-btn" onclick="copyLink()">Copy</button>
                            </div>
                            <div class="access-code">
                                <p>Access Code: <span id="accessCode"></span></p>
                            </div>
                            <p class="note">Note: This link and code are unique to this guest and cannot be used by others.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html> 