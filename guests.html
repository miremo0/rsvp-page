<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest List - Our Autumn Wedding</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, get, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-Owb-RYgi0khn4GW0qBxcZD2zc6cP6Gk",
            authDomain: "mywed-5a5b9.firebaseapp.com",
            databaseURL: "https://mywed-5a5b9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywed-5a5b9",
            storageBucket: "mywed-5a5b9.firebasestorage.app",
            messagingSenderId: "537064292333",
            appId: "1:537064292333:web:c18ee6c8cbc08cf2b931e4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Function to hash password using Web Crypto API
        async function hashPassword(password) {
            const msgUint8 = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Function to verify admin password
        async function verifyAdminPassword(password) {
            try {
                const adminRef = ref(database, 'admin/password');
                const snapshot = await get(adminRef);
                
                if (snapshot.exists()) {
                    // Get the hashed password from Firebase
                    const hashedPasswordFromDB = snapshot.val();
                    
                    // Hash the input password
                    const hashedInput = await hashPassword(password);
                    console.log('Input Hash:', hashedInput);
                    console.log('DB Hash:', hashedPasswordFromDB);
                    
                    // Compare the hashes
                    return hashedInput === hashedPasswordFromDB;
                }
                return false;
            } catch (error) {
                console.error('Error verifying password:', error);
                return false;
            }
        }

        // Function to update guest sides
        async function updateGuestSides() {
            try {
                const guestsRef = ref(database, 'guests');
                const snapshot = await get(guestsRef);
                
                if (snapshot.exists()) {
                    const guests = snapshot.val();
                    const updates = {};
                    
                    Object.entries(guests).forEach(([key, guest]) => {
                        console.log(`Processing guest: ${guest.name}, Category: ${guest.category}, Role: ${guest.role}`);
                        
                        let side;
                        const role = guest.role ? guest.role.toLowerCase() : '';
                        
                        // First check if the role contains explicit side indicators
                        if (role.includes('brides')) {
                            side = 'bride';
                        } else if (role.includes('grooms')) {
                            side = 'groom';
                        } else if (role.startsWith('bride')) {
                            side = 'bride';
                        } else if (role.startsWith('groom')) {
                            side = 'groom';
                        }
                        
                        // If no side was determined by prefix, check category-specific rules
                        if (!side) {
                            if (guest.category === 'Principal') {
                                if (role.includes('ninong')) {
                                    side = 'groom';
                                } else if (role.includes('ninang')) {
                                    side = 'bride';
                                }
                            } else if (guest.category === 'Entourage') {
                                if (role.includes('groomsmen') || 
                                    role.includes('bestman') || 
                                    role.includes('best man')) {
                                    side = 'groom';
                                } else if (role.includes('bridesmaid') || 
                                         role.includes('maid of honor') || 
                                         role.includes('matron of honor')) {
                                    side = 'bride';
                                }
                            }
                        }

                        // If we determined a side, update it
                        if (side) {
                            console.log(`Setting ${guest.name} to ${side} side`);
                            updates[`guests/${key}/side`] = side;
                        }

                        // Check if the category needs to be updated (e.g., Mary Grace Ong)
                        if (guest.name === 'Mary Grace Ong' && guest.category !== 'Family') {
                            updates[`guests/${key}/category`] = 'Family';
                            console.log(`Updating ${guest.name}'s category to Family`);
                        }
                    });
                    
                    // Apply updates if there are any
                    if (Object.keys(updates).length > 0) {
                        console.log('Updates to be applied:', updates);
                        await update(ref(database), updates);
                        console.log('Guest sides and categories updated successfully');
                        return true;
                    } else {
                        console.log('No updates needed');
                    }
                    return false;
                }
                return false;
            } catch (error) {
                console.error('Error updating guest sides:', error);
                return false;
            }
        }

        // Function to load and display guest list
        async function loadGuestList() {
            try {
                // Update guest sides before loading the list
                await updateGuestSides();
                
                const guestsRef = ref(database, 'guests');
                onValue(guestsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const guests = snapshot.val();
                        displayGuestList(guests);
                    } else {
                        console.log('No guests found');
                        displayNoGuests();
                    }
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });
            } catch (error) {
                console.error('Error loading guest list:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Function to display guest list
        function displayGuestList(guests) {
            const guestListContainer = document.getElementById('guestList');
            guestListContainer.innerHTML = '';

            // Calculate attendance statistics
            const stats = {
                total: Object.keys(guests).length,
                attending: Object.values(guests).filter(g => g.rsvpStatus === 'Attending').length,
                pending: Object.values(guests).filter(g => g.rsvpStatus !== 'Attending').length
            };

            // Update the status legend with counts
            const statusLegend = document.querySelector('.status-legend');
            statusLegend.innerHTML = `
                <div class="legend-stats">
                    <div class="stats-item">
                        <span class="stats-number">${stats.total}</span>
                        <span class="stats-label">Total Guests</span>
                    </div>
                    <div class="stats-divider"></div>
                    <div class="stats-item">
                        <span class="stats-number attending">${stats.attending}</span>
                        <span class="stats-label">Attending</span>
                    </div>
                    <div class="stats-divider"></div>
                    <div class="stats-item">
                        <span class="stats-number pending">${stats.pending}</span>
                        <span class="stats-label">Pending</span>
                    </div>
                </div>
            `;

            // Group guests by category first
            const categories = {
                'Family': { bride: [], groom: [] },
                'Principal': { bride: [], groom: [] },
                'Entourage': { bride: [], groom: [] },
                'Guest': { bride: [], groom: [] }
            };

            // Sort and group guests
            Object.entries(guests).forEach(([guestId, guest]) => {
                const category = guest.category || 'Guest';
                const side = guest.side || 'bride';
                
                if (categories[category]) {
                    categories[category][side].push({
                        id: guestId,
                        ...guest
                    });
                }
            });

            // Sort function for guests within each category
            const sortGuests = (a, b) => {
                const rolePriorityA = getRolePriority(a.role);
                const rolePriorityB = getRolePriority(b.role);
                if (rolePriorityA !== rolePriorityB) return rolePriorityA - rolePriorityB;
                return a.name.localeCompare(b.name);
            };

            // Create category sections
            Object.entries(categories).forEach(([category, sides]) => {
                // Sort guests within each side
                sides.bride.sort(sortGuests);
                sides.groom.sort(sortGuests);

                // Only create section if there are guests in this category
                if (sides.bride.length > 0 || sides.groom.length > 0) {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'category-section';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header';
                    
                    const categoryTitle = document.createElement('h2');
                    categoryTitle.className = 'category-title';
                    categoryTitle.textContent = category;
                    
                    const addButton = document.createElement('button');
                    addButton.className = 'add-guest-btn';
                    addButton.textContent = 'Add Guest';
                    addButton.onclick = () => {
                        openAddGuestModal();
                        // Pre-select the category in the modal
                        document.getElementById('editCategory').value = category;
                    };
                    
                    categoryHeader.appendChild(categoryTitle);
                    categoryHeader.appendChild(addButton);
                    categorySection.appendChild(categoryHeader);

                    const columnsContainer = document.createElement('div');
                    columnsContainer.className = 'side-columns';

                    // Bride's side column
                    const brideColumn = document.createElement('div');
                    brideColumn.className = 'side-column';
                    brideColumn.innerHTML = '<h3>Bride\'s Side</h3>';
                    sides.bride.forEach(guest => {
                        brideColumn.appendChild(createGuestCard(guest));
                    });

                    // Groom's side column
                    const groomColumn = document.createElement('div');
                    groomColumn.className = 'side-column';
                    groomColumn.innerHTML = '<h3>Groom\'s Side</h3>';
                    sides.groom.forEach(guest => {
                        groomColumn.appendChild(createGuestCard(guest));
                    });

                    columnsContainer.appendChild(brideColumn);
                    columnsContainer.appendChild(groomColumn);
                    categorySection.appendChild(columnsContainer);
                    guestListContainer.appendChild(categorySection);
                }
            });
        }

        // Helper function to create guest card
        function createGuestCard(guest) {
            const guestCard = document.createElement('div');
            guestCard.className = 'guest-card';
            
            const guestInfo = document.createElement('div');
            guestInfo.className = 'guest-info';
            
            const nameElement = document.createElement('div');
            nameElement.className = 'guest-name';
            nameElement.textContent = guest.name;
            
            const roleElement = document.createElement('div');
            roleElement.className = 'guest-role';
            roleElement.textContent = guest.role;
            
            guestInfo.appendChild(nameElement);
            guestInfo.appendChild(roleElement);
            
            const guestCardActions = document.createElement('div');
            guestCardActions.className = 'guest-card-actions';
            
            const statusElement = document.createElement('div');
            statusElement.className = 'status ' + (guest.rsvpStatus === 'Attending' ? 'status-attending' : 'status-pending');
            statusElement.textContent = guest.rsvpStatus || 'Pending';
            
            const generateLinkBtn = document.createElement('button');
            generateLinkBtn.className = 'generate-link-btn';
            generateLinkBtn.textContent = 'Get Link';
            generateLinkBtn.onclick = () => generateInvitationLink(guest.id, guest.accessCode);
            
            const editButton = document.createElement('button');
            editButton.className = 'edit-guest-btn';
            editButton.textContent = 'Edit';
            editButton.onclick = () => openEditModal(guest.id);
            
            guestCardActions.appendChild(statusElement);
            guestCardActions.appendChild(generateLinkBtn);
            guestCardActions.appendChild(editButton);
            
            guestCard.appendChild(guestInfo);
            guestCard.appendChild(guestCardActions);
            
            return guestCard;
        }

        function displayNoGuests() {
            const guestList = document.getElementById('guestList');
            guestList.innerHTML = '<div class="no-guests">No guests found</div>';
        }

        // Function to generate a random access code
        function generateAccessCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }

        // Function to update guest's access code
        async function updateGuestAccessCode(guestName, newAccessCode) {
            try {
                const guestsRef = ref(database, 'guests');
                const snapshot = await get(guestsRef);
                
                if (snapshot.exists()) {
                    const guests = snapshot.val();
                    const guestKey = Object.keys(guests).find(key => 
                        guests[key].name === guestName
                    );

                    if (guestKey) {
                        const updates = {};
                        updates[`guests/${guestKey}/accessCode`] = newAccessCode;
                        await update(ref(database), updates);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error updating access code:', error);
                return false;
            }
        }

        // Function to generate invitation link
        async function generateInvitationLink(guestId, accessCode) {
            console.log('üîó Generating invitation link for guest:', guestId);
            try {
                // Get guest data first
                const guestRef = ref(database, `guests/${guestId}`);
                const snapshot = await get(guestRef);
                
                if (!snapshot.exists()) {
                    console.error('‚ùå Guest not found');
                    alert('Error: Guest not found');
                    return;
                }

                const guest = snapshot.val();
                let finalAccessCode = accessCode;
                
                if (!finalAccessCode) {
                    console.log('üîë No access code found, generating new one...');
                    finalAccessCode = generateAccessCode();
                    
                    // Update guest with new access code
                    await update(guestRef, {
                        accessCode: finalAccessCode
                    });
                    console.log('‚úÖ Access code updated successfully');
                }

                const baseUrl = window.location.origin + window.location.pathname.replace('guests.html', 'rsvp.html');
                const link = `${baseUrl}?guest=${encodeURIComponent(guest.name)}&code=${encodeURIComponent(finalAccessCode)}`;
                
                // Generate personalized message
                const message = `Hi ${guest.name}, my ${guest.role}! üçÇ

You are cordially invited to celebrate our wedding day with us. Your presence would make our special day even more meaningful.

Please use this link to RSVP:
${link}

Your access code is: ${finalAccessCode}

We look forward to sharing this joyous occasion with you!

With love,
Jaycel & Murphy`;
                
                console.log('üì® Generated link:', link);
                
                // Update modal content and show it
                document.getElementById('guestNameSpan').textContent = guest.name;
                document.getElementById('invitationLink').value = link;
                document.getElementById('accessCode').textContent = finalAccessCode;
                document.getElementById('invitationMessage').value = message;
                
                const modal = document.getElementById('linkModal');
                modal.style.display = 'block';
            } catch (error) {
                console.error('‚ùå Error generating invitation link:', error);
                alert('Error generating invitation link. Please try again.');
            }
        }

        // Function to copy text
        function copyText(elementId) {
            const element = document.getElementById(elementId);
            
            // Handle both input and textarea elements
            if (element.tagName.toLowerCase() === 'textarea') {
                element.focus();
                element.setSelectionRange(0, element.value.length);
            } else {
                element.select();
            }
            
            try {
                // Try the new clipboard API first
                navigator.clipboard.writeText(element.value).then(() => {
                    const copyBtn = document.getElementById(`copy${elementId.charAt(0).toUpperCase() + elementId.slice(1)}Btn`);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = elementId === 'invitationMessage' ? 'Copy Message' : 'Copy Link';
                    }, 2000);
                });
            } catch (err) {
                // Fallback to the old method
                document.execCommand('copy');
                const copyBtn = document.getElementById(`copy${elementId.charAt(0).toUpperCase() + elementId.slice(1)}Btn`);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = elementId === 'invitationMessage' ? 'Copy Message' : 'Copy Link';
                }, 2000);
            }
        }

        // Function to close modal
        function closeModal() {
            const modal = document.getElementById('linkModal');
            modal.style.display = 'none';
        }

        // Function to extract and save unique roles
        async function extractAndSaveRoles() {
            try {
                const guestsRef = ref(database, 'guests');
                const snapshot = await get(guestsRef);
                
                if (snapshot.exists()) {
                    const guests = snapshot.val();
                    const uniqueRoles = new Set();
                    
                    // Extract unique roles
                    Object.values(guests).forEach(guest => {
                        if (guest.role) {
                            uniqueRoles.add(guest.role.trim());
                        }
                    });
                    
                    // Convert Set to array and sort alphabetically
                    const rolesArray = Array.from(uniqueRoles).sort();
                    
                    // Create roles object with categories
                    const rolesData = {
                        Principal: rolesArray.filter(role => {
                            const lowerRole = role.toLowerCase();
                            return lowerRole.includes('ninang') || 
                                   lowerRole.includes('ninong');
                        }),
                        Entourage: rolesArray.filter(role => {
                            const lowerRole = role.toLowerCase();
                            return lowerRole.includes('bridesmaid') || 
                                   lowerRole.includes('groomsmen') ||
                                   lowerRole.includes('groomsman') ||
                                   lowerRole.includes('maid of honor') ||
                                   lowerRole.includes('matron of honor') ||
                                   lowerRole.includes('best man') ||
                                   lowerRole.includes('bestman') ||
                                   lowerRole === 'entourage bestman' ||
                                   lowerRole === 'entourage bridesmaid';
                        }),
                        Family: rolesArray.filter(role => {
                            const lowerRole = role.toLowerCase();
                            return lowerRole.includes('mother') || 
                                   lowerRole.includes('father') ||
                                   lowerRole.includes('sister') ||
                                   lowerRole.includes('brother') ||
                                   lowerRole.includes('cousin') ||
                                   lowerRole.includes('uncle') ||
                                   lowerRole.includes('auntie') ||
                                   lowerRole.includes('aunt') ||
                                   lowerRole.includes('nephew') ||
                                   lowerRole.includes('niece');
                        }),
                        Guest: rolesArray.filter(role => {
                            const lowerRole = role.toLowerCase();
                            return lowerRole.includes('guest') ||
                                   lowerRole.includes('friend');
                        }),
                        Other: rolesArray.filter(role => {
                            const lowerRole = role.toLowerCase();
                            return !lowerRole.includes('ninang') &&
                                   !lowerRole.includes('ninong') &&
                                   !lowerRole.includes('bridesmaid') &&
                                   !lowerRole.includes('groomsmen') &&
                                   !lowerRole.includes('groomsman') &&
                                   !lowerRole.includes('maid of honor') &&
                                   !lowerRole.includes('matron of honor') &&
                                   !lowerRole.includes('best man') &&
                                   !lowerRole.includes('bestman') &&
                                   !lowerRole.includes('mother') &&
                                   !lowerRole.includes('father') &&
                                   !lowerRole.includes('sister') &&
                                   !lowerRole.includes('brother') &&
                                   !lowerRole.includes('cousin') &&
                                   !lowerRole.includes('uncle') &&
                                   !lowerRole.includes('auntie') &&
                                   !lowerRole.includes('aunt') &&
                                   !lowerRole.includes('nephew') &&
                                   !lowerRole.includes('niece') &&
                                   !lowerRole.includes('guest') &&
                                   !lowerRole.includes('friend');
                        })
                    };
                    
                    // Save to Firebase
                    await update(ref(database, 'roles'), rolesData);
                    console.log('Roles saved successfully:', rolesData);
                    return rolesData;
                }
                return null;
            } catch (error) {
                console.error('Error extracting and saving roles:', error);
                return null;
            }
        }

        // Function to edit guest
        async function editGuest(guestKey) {
            openEditModal(guestKey);
        }

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing authentication
            if (sessionStorage.getItem('isAuthenticated')) {
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                extractAndSaveRoles().then(() => {
                    loadGuestList();
                });
            }

            // Password check
            document.getElementById('submitPassword').addEventListener('click', async function() {
                const password = document.getElementById('guestListPassword').value;
                const loadingIndicator = document.getElementById('loadingIndicator');
                const passwordError = document.getElementById('passwordError');
                
                try {
                    loadingIndicator.classList.remove('hidden');
                    passwordError.textContent = '';
                    
                    const isValid = await verifyAdminPassword(password);
                    
                    if (isValid) {
                        sessionStorage.setItem('isAuthenticated', 'true');
                        document.getElementById('passwordOverlay').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        extractAndSaveRoles().then(() => {
                            loadGuestList();
                        });
                    } else {
                        passwordError.textContent = 'Incorrect password';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    passwordError.textContent = 'Error verifying password. Please try again.';
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            });

            // Handle enter key
            document.getElementById('guestListPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('submitPassword').click();
                }
            });

            // Handle modal close when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('linkModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
        });

        // Make functions available globally
        window.loadGuestList = loadGuestList;
        window.generateInvitationLink = generateInvitationLink;
        window.copyText = copyText;
        window.closeModal = closeModal;
        window.updateGuestSides = updateGuestSides;
        window.editGuest = editGuest;
        window.extractAndSaveRoles = extractAndSaveRoles;
        window.closeEditModal = closeEditModal;
        window.saveGuestChanges = saveGuestChanges;

        // Function to standardize role format
        function standardizeRole(role, side = '') {
            if (!role) return '';
            
            role = role.trim();
            // Convert to Title Case
            role = role.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            
            // Remove any dashes
            role = role.replace(/-/g, ' ');

            // Standardize specific roles
            const roleMap = {
                'Bestman': 'Best Man',
                'Groomsmen': 'Groomsman',
                'Matron Of Honor': 'Maid of Honor'
            };

            // Apply standard mappings
            if (roleMap[role]) {
                role = roleMap[role];
            }

            // Add side prefix for family and guests if not already present
            if (side && !role.includes("'s") && (role.includes('Mother') || role.includes('Father') || 
                role.includes('Sister') || role.includes('Brother') || role.includes('Cousin') ||
                role.includes('Friend') || role === 'Guest')) {
                role = `${side}'s ${role}`;
            }

            return role;
        }

        // Function to open edit modal
        function openEditModal(guestId) {
            console.log('üîç Opening edit modal for guest:', guestId);
            
            const editModal = document.getElementById('editGuestModal');
            const form = document.getElementById('editGuestForm');
            const modalTitle = document.getElementById('modalTitle');
            const saveButton = document.getElementById('saveButton');
            
            // Get guest data
            const guestRef = ref(database, `guests/${guestId}`);
            get(guestRef).then(async (snapshot) => {
                if (snapshot.exists()) {
                    const guest = snapshot.val();
                    console.log('üìÑ Current guest data:', guest);
                    
                    // Get roles for dropdown
                    const rolesRef = ref(database, 'roles');
                    const rolesSnapshot = await get(rolesRef);
                    const roles = rolesSnapshot.exists() ? rolesSnapshot.val() : {};
                    console.log('üìã Available roles:', roles);
                    
                    // Create role options HTML
                    const roleOptions = Object.entries(roles)
                        .flatMap(([category, roleList]) => 
                            roleList.map(role => 
                                `<option value="${role}" ${guest.role === role ? 'selected' : ''}>${role}</option>`
                            )
                        )
                        .join('');
                    
                    // Populate form fields
                    document.getElementById('editName').value = guest.name || '';
                    document.getElementById('editCategory').value = guest.category || '';
                    document.getElementById('editRole').innerHTML = roleOptions;
                    document.getElementById('editRole').value = guest.role || '';
                    document.getElementById('editSide').value = guest.side || '';
                    
                    // Store guest ID for saving
                    form.dataset.guestId = guestId;
                    
                    // Update modal title and button text
                    modalTitle.textContent = 'Edit Guest';
                    saveButton.textContent = 'Save Changes';
                    
                    // Set form submit handler for editing
                    form.onsubmit = saveGuestChanges;
                    
                    console.log('‚úÖ Form populated successfully');
                    
                    // Show modal
                    editModal.style.display = 'block';
                } else {
                    console.error('‚ùå Guest not found:', guestId);
                }
            }).catch(error => {
                console.error('‚ùå Error loading guest data:', error);
            });
        }

        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('editGuestModal').style.display = 'none';
        }

        // Function to add new guest
        async function addNewGuest(event) {
            event.preventDefault();
            console.log('üÜï Starting to add new guest...');
            
            const name = document.getElementById('editName').value;
            const category = document.getElementById('editCategory').value;
            const role = document.getElementById('editRole').value;
            const side = document.getElementById('editSide').value;
            
            console.log('üìù New guest details:', {
                name,
                category,
                role,
                side
            });
            
            try {
                // Generate a new access code
                const accessCode = generateAccessCode();
                
                // Create new guest object
                const newGuest = {
                    name,
                    category,
                    role,
                    side,
                    accessCode,
                    rsvpStatus: 'Pending',
                    timestamp: new Date().toISOString()
                };
                
                // Push to Firebase
                const guestsRef = ref(database, 'guests');
                const newGuestRef = push(guestsRef);
                await set(newGuestRef, newGuest);
                
                console.log('‚úÖ New guest added successfully');
                
                // Close modal
                document.getElementById('editGuestModal').style.display = 'none';
                
                // Refresh guest list
                console.log('üîÑ Refreshing guest list...');
                await loadGuestList();
                
                // Extract and save updated roles
                console.log('üîÑ Updating roles...');
                await extractAndSaveRoles();
                
                console.log('‚ú® All updates completed successfully');
            } catch (error) {
                console.error('‚ùå Error adding new guest:', error);
                alert('Error adding new guest. Please try again.');
            }
        }

        // Make addNewGuest available globally
        window.addNewGuest = addNewGuest;

        // Update the modal HTML to support both edit and add modes
        if (!document.getElementById('editGuestModal')) {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="editGuestModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeEditModal()">&times;</span>
                        <h2 id="modalTitle">Edit Guest</h2>
                        <form id="editGuestForm">
                            <div class="form-group">
                                <label for="editName">Name:</label>
                                <input type="text" id="editName" required>
                            </div>
                            <div class="form-group">
                                <label for="editCategory">Category:</label>
                                <select id="editCategory" required>
                                    <option value="Principal">Principal</option>
                                    <option value="Entourage">Entourage</option>
                                    <option value="Family">Family</option>
                                    <option value="Guest">Guest</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editRole">Role:</label>
                                <select id="editRole" required></select>
                            </div>
                            <div class="form-group">
                                <label for="editSide">Side:</label>
                                <select id="editSide" required>
                                    <option value="bride">Bride's Side</option>
                                    <option value="groom">Groom's Side</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="save-btn" id="saveButton">Save Changes</button>
                                <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
        }

        // Function to open modal in add mode
        function openAddGuestModal() {
            console.log('üÜï Opening add guest modal');
            const editModal = document.getElementById('editGuestModal');
            const form = document.getElementById('editGuestForm');
            const modalTitle = document.getElementById('modalTitle');
            const saveButton = document.getElementById('saveButton');
            
            // Clear form fields
            document.getElementById('editName').value = '';
            document.getElementById('editCategory').value = 'Guest';
            document.getElementById('editSide').value = 'bride';
            
            // Update modal title and button text
            modalTitle.textContent = 'Add New Guest';
            saveButton.textContent = 'Add Guest';
            
            // Change form submit handler
            form.onsubmit = addNewGuest;
            
            // Get roles for dropdown
            const rolesRef = ref(database, 'roles');
            get(rolesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const roles = snapshot.val();
                    const roleSelect = document.getElementById('editRole');
                    roleSelect.innerHTML = Object.entries(roles)
                        .flatMap(([category, roleList]) => 
                            roleList.map(role => 
                                `<option value="${role}">${role}</option>`
                            )
                        )
                        .join('');
                }
            });
            
            // Show modal
            editModal.style.display = 'block';
        }

        // Make openAddGuestModal available globally
        window.openAddGuestModal = openAddGuestModal;

        // Add styles for the Add Guest button
        const style = document.createElement('style');
        style.textContent = `
            .category-header {
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                margin-bottom: 20px;
            }

            .category-title {
                text-align: center;
                font-family: 'Great Vibes', cursive;
                font-size: 2.5em;
                color: #4a4a4a;
                margin: 0;
                padding-bottom: 10px;
                border-bottom: 2px solid #ddd;
                flex-grow: 1;
            }

            .add-guest-btn {
                position: absolute;
                right: 0;
                padding: 8px 16px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                transition: background-color 0.2s;
            }

            .add-guest-btn:hover {
                background-color: #45a049;
            }

            @media (max-width: 768px) {
                .category-header {
                    flex-direction: column;
                    gap: 10px;
                }

                .add-guest-btn {
                    position: static;
                    margin-bottom: 10px;
                }

                .category-title {
                    font-size: 2em;
                    margin-bottom: 10px;
                }
            }
        `;
        document.head.appendChild(style);

        // Function to get role priority for sorting
        function getRolePriority(role) {
            if (!role) return 99;
            const roleLower = role.toLowerCase();
            
            // Principal priorities
            if (roleLower.includes('ninang')) return 1;
            if (roleLower.includes('ninong')) return 1;
            
            // Entourage priorities
            if (roleLower.includes('maid of honor')) return 1;
            if (roleLower.includes('best man') || roleLower.includes('bestman')) return 1;
            if (roleLower.includes('bridesmaid')) return 2;
            if (roleLower.includes('groomsman')) return 2;
            
            // Family priorities
            if (roleLower.includes('mother')) return 1;
            if (roleLower.includes('father')) return 1;
            if (roleLower.includes('sister')) return 2;
            if (roleLower.includes('brother')) return 2;
            if (roleLower.includes('cousin')) return 3;
            
            // Guest priorities
            if (roleLower.includes('friend')) return 1;
            
            return 99; // Default priority
        }

        // Function to save guest changes
        async function saveGuestChanges(event) {
            event.preventDefault();
            console.log('üîÑ Starting to save guest changes...');
            
            const form = event.target;
            const guestId = form.dataset.guestId;
            
            if (!guestId) {
                console.error('‚ùå No guest ID found in form data');
                return;
            }
            
            const name = document.getElementById('editName').value;
            const category = document.getElementById('editCategory').value;
            const role = document.getElementById('editRole').value;
            const side = document.getElementById('editSide').value;
            
            console.log('üìù Guest details to update:', {
                id: guestId,
                name,
                category,
                role,
                side
            });
            
            try {
                // Update guest in Firebase
                const guestRef = ref(database, `guests/${guestId}`);
                await update(guestRef, {
                    name,
                    category,
                    role,
                    side,
                    timestamp: new Date().toISOString()
                });
                
                console.log('‚úÖ Guest updated successfully');
                
                // Close modal
                document.getElementById('editGuestModal').style.display = 'none';
                
                // Refresh guest list
                console.log('üîÑ Refreshing guest list...');
                await loadGuestList();
                
                // Extract and save updated roles
                console.log('üîÑ Updating roles...');
                await extractAndSaveRoles();
                
                console.log('‚ú® All updates completed successfully');
            } catch (error) {
                console.error('‚ùå Error updating guest:', error);
                alert('Error updating guest. Please try again.');
            }
        }
    </script>
    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .save-btn,
        .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .save-btn {
            background-color: #4CAF50;
            color: white;
        }

        .save-btn:hover {
            background-color: #45a049;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #da190b;
        }

        .edit-guest-btn {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        .edit-guest-btn:hover {
            background-color: #1976D2;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20% auto;
                width: 95%;
                padding: 15px;
            }

            .form-actions {
                flex-direction: column;
            }

            .save-btn,
            .cancel-btn {
                width: 100%;
            }
        }

        /* Guest List Styles */
        .guest-list {
            padding: 20px;
            display: block; /* Change from flex to block */
        }

        .side-column {
            flex: 1;
            min-width: 300px;
        }

        .side-column h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a4a4a;
            font-family: 'Great Vibes', cursive;
            font-size: 2em;
        }

        .guest-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .guest-info {
            flex-grow: 1;
            margin-right: 10px;
        }

        .guest-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .guest-role {
            color: #666;
            font-size: 0.9em;
        }

        .guest-card-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            text-align: center;
            min-width: 90px;
            font-family: 'Lora', serif;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .status-attending {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .status-pending {
            background-color: #FFC107;
            color: #333;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }

        @media (max-width: 768px) {
            .guest-list {
                flex-direction: column;
            }

            .side-column {
                min-width: unset;
            }

            .guest-card {
                flex-direction: column;
            }

            .guest-card-actions {
                flex-direction: row;
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
        }

        /* Category Section Styles */
        .category-section {
            margin-bottom: 40px;
        }

        .category-title {
            text-align: center;
            font-family: 'Great Vibes', cursive;
            font-size: 2.5em;
            color: #4a4a4a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }

        .side-columns {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .side-column {
            flex: 1;
            min-width: 300px;
        }

        .side-column h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-family: 'Lora', serif;
            font-size: 1.2em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .side-columns {
                flex-direction: column;
            }

            .side-column {
                min-width: unset;
            }

            .category-title {
                font-size: 2em;
            }
        }

        /* Status Legend Styles */
        .status-legend {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px 25px;
            margin: 20px auto;
            max-width: 600px;
        }

        .legend-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .stats-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 15px;
        }

        .stats-number {
            font-family: 'Lora', serif;
            font-size: 2em;
            font-weight: 600;
            color: #333;
            line-height: 1;
        }

        .stats-number.attending {
            color: #4CAF50;
        }

        .stats-number.pending {
            color: #FFC107;
        }

        .stats-label {
            font-family: 'Lora', serif;
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        .stats-divider {
            width: 1px;
            height: 40px;
            background: #ddd;
        }

        @media (max-width: 768px) {
            .status-legend {
                margin: 15px 10px;
                padding: 12px 15px;
            }

            .stats-number {
                font-size: 1.6em;
            }

            .stats-label {
                font-size: 0.8em;
            }

            .stats-divider {
                height: 35px;
            }
        }

        /* Link Modal Styles */
        .link-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .link-modal.show {
            display: block;
        }

        .link-modal .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .link-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .link-container input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: #f8f8f8;
        }

        .copy-btn {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .copy-btn:hover {
            background-color: #1976D2;
        }

        .access-code {
            margin: 15px 0;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            text-align: center;
        }

        .access-code span {
            font-weight: 600;
            color: #2196F3;
            letter-spacing: 1px;
        }

        .note {
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
            font-style: italic;
        }

        .message-container {
            margin: 15px 0;
        }

        .message-container textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            background: #f8f8f8;
            font-family: 'Lora', serif;
            margin-bottom: 10px;
        }

        .separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .separator::before,
        .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background-color: #ddd;
        }

        .separator::before {
            left: 0;
        }

        .separator::after {
            right: 0;
        }

        .separator span {
            background-color: white;
            padding: 0 10px;
            color: #666;
            font-size: 0.9em;
        }

        .copy-btn {
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="falling-leaves"></div>
    <div class="container">
        <div id="passwordOverlay" class="password-overlay">
            <div class="password-container">
                <h2>Private Guest List</h2>
                <p>Please enter the password to view the guest list</p>
                <div class="password-form">
                    <input type="password" id="guestListPassword" placeholder="Enter password">
                    <button id="submitPassword" class="rsvp-button">View Guest List</button>
                </div>
                <div id="passwordError" class="password-error"></div>
            </div>
        </div>

        <div id="mainContent" class="hidden">
            <header class="header">
                <a href="index.html" class="back-home">‚Üê Back to Home</a>
                <h1 class="page-title">Guest List</h1>
            </header>

            <main class="guest-list-container">
                <div class="guest-list-header">
                    <div id="loadingIndicator" class="loading-indicator">
                        Loading guest list...
                    </div>
                    <div class="status-legend">
                        <div class="legend-item">
                            <span class="status-dot attending"></span>
                            <span>Attending</span>
                        </div>
                        <div class="legend-item">
                            <span class="status-dot pending"></span>
                            <span>Pending</span>
                        </div>
                    </div>
                </div>

                <div id="guestList" class="guest-list">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div id="linkModal" class="link-modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal()">&times;</span>
                        <h2>Invitation Link</h2>
                        <div class="invitation-details">
                            <p>Share this message with <span id="guestNameSpan"></span>:</p>
                            
                            <div class="message-container">
                                <textarea id="invitationMessage" readonly></textarea>
                                <button id="copyMessageBtn" class="copy-btn" onclick="copyText('invitationMessage')">Copy Message</button>
                            </div>

                            <div class="separator">
                                <span>or copy link only</span>
                            </div>
                            
                            <div class="link-container">
                                <input type="text" id="invitationLink" readonly>
                                <button id="copyLinkBtn" class="copy-btn" onclick="copyText('invitationLink')">Copy Link</button>
                            </div>
                            
                            <div class="access-code">
                                <p>Access Code: <span id="accessCode"></span></p>
                            </div>
                            <p class="note">Note: This link and code are unique to this guest and cannot be used by others.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html> 